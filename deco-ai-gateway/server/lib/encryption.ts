import {
  type CipherGCM,
  type DecipherGCM,
  createCipheriv,
  createDecipheriv,
  randomBytes,
} from "node:crypto";

const IV_LENGTH = 12;

interface EncryptedData {
  ciphertext: string;
  iv: string;
  tag: string;
}

/**
 * Resolves the AES encryption key from environment variables.
 *
 * Priority:
 * 1. DECO_CRYPTO_KEY — auto-generated by the platform (Base64 JSON with key bytes).
 *    Format: btoa(JSON.stringify({ key: Record<string,number>, iv: ... }))
 *    Key size: 16 bytes → aes-128-gcm
 *
 * 2. ENCRYPTION_KEY — manual 32-byte hex key.
 *    Format: 64 hex characters → aes-256-gcm
 */
function getEncryptionKey(): { key: Buffer; algorithm: string } {
  const decoCryptoKey = process.env.DECO_CRYPTO_KEY;

  if (decoCryptoKey) {
    const parsed = JSON.parse(
      Buffer.from(decoCryptoKey, "base64").toString("utf8"),
    ) as { key: Record<string, number> };

    const keyBytes = Buffer.from(Object.values(parsed.key));
    const algorithm = keyBytes.length === 16 ? "aes-128-gcm" : "aes-256-gcm";
    return { key: keyBytes, algorithm };
  }

  const keyHex = process.env.ENCRYPTION_KEY;
  if (!keyHex) {
    throw new Error(
      "Either DECO_CRYPTO_KEY (auto-generated) or ENCRYPTION_KEY (64 hex chars) must be set.",
    );
  }
  if (!/^[0-9a-fA-F]{64}$/.test(keyHex)) {
    throw new Error(
      "ENCRYPTION_KEY must be exactly 64 hexadecimal characters (32 bytes). Generate with: openssl rand -hex 32",
    );
  }
  return { key: Buffer.from(keyHex, "hex"), algorithm: "aes-256-gcm" };
}

export function encrypt(plaintext: string): EncryptedData {
  const { key, algorithm } = getEncryptionKey();
  const iv = randomBytes(IV_LENGTH);
  const cipher = createCipheriv(algorithm, key, iv) as CipherGCM;

  let encrypted = cipher.update(plaintext, "utf8", "base64");
  encrypted += cipher.final("base64");

  return {
    ciphertext: encrypted,
    iv: iv.toString("hex"),
    tag: cipher.getAuthTag().toString("hex"),
  };
}

export function decrypt(data: EncryptedData): string {
  const { key, algorithm } = getEncryptionKey();
  const iv = Buffer.from(data.iv, "hex");
  const tag = Buffer.from(data.tag, "hex");

  const decipher = createDecipheriv(algorithm, key, iv) as DecipherGCM;
  decipher.setAuthTag(tag);

  let decrypted = decipher.update(data.ciphertext, "base64", "utf8");
  decrypted += decipher.final("utf8");

  return decrypted;
}
